name: GHCR nightly cleanup (single script)

on:
  schedule:
    - cron: "30 18 * * *"  # 每天 JST 03:30（UTC 18:30）
  workflow_dispatch:
    inputs:
      retention_days:
        description: "临时标签至少保留天数"
        type: number
        default: 3

permissions:
  packages: write
  contents: read

env:
  REPO: ${{ github.repository }}        # owner/repo
  OWNER: ${{ github.repository_owner }}
  KEEP_TAGS: ${{ format('latest {0}', github.event.repository.default_branch || 'main') }}
  RETENTION_DAYS: ${{ (github.event_name == 'workflow_dispatch' && inputs.retention_days) || 3 }}
  TEMP_TAG_REGEX: '^[0-9a-f]{40}-(amd64|arm64)$'

jobs:
  cleanup:
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - uses: actions/checkout@main
      - name: Run cleanup script
        run: |
          chmod +x .github/scripts/ghcr-clean.sh
          .github/scripts/ghcr-clean.sh
