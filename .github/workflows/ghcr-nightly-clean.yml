name: GHCR nightly cleanup (lean)

on:
    schedule:
        - cron: "30 18 * * *" # 每天 JST 03:30（UTC 18:30）
    workflow_dispatch:
        inputs:
            dry_run:
                description: "只预览不删除"
                type: boolean
                default: false
            retention_days:
                description: "临时标签至少保留天数"
                type: number
                default: 3

permissions:
    packages: write
    contents: read

env:
    REPO: ${{ github.repository }} # owner/repo
    OWNER: ${{ github.repository_owner }}
    KEEP_TAGS: ${{ format('latest {0}', github.event.repository.default_branch || 'main') }}
    RETENTION_DAYS: ${{ (github.event_name == 'workflow_dispatch' && inputs.retention_days) || 3 }}
    DRY_RUN: ${{ (github.event_name == 'workflow_dispatch' && (inputs.dry_run && 'true' || 'false')) || 'false' }}
    TEMP_TAG_REGEX: "^[0-9a-f]{40}-(amd64|arm64)$"

jobs:
    cleanup:
        runs-on: ubuntu-latest
        env:
            GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

        steps:
            - name: Build protected digest set
              id: protect
              shell: bash
              run: |
                  set -Eeuo pipefail
                  owner="${OWNER,,}"
                  image="${REPO#*/}"; image="${image,,}"
                  repo="${owner}/${image}"

                  auth="${GITHUB_TOKEN:-${GH_TOKEN:-}}"
                  if [ -z "$auth" ]; then
                    echo "ERROR: GITHUB_TOKEN not available" >&2
                    exit 1
                  fi

                  token="$(curl -fsSL -u "${GITHUB_ACTOR}:${auth}" \
                           "https://ghcr.io/token?scope=repository:${repo}:pull" \
                           | jq -r .token)"

                  prot="$(mktemp)"; : > "$prot"
                  accept_index='application/vnd.oci.image.index.v1+json, application/vnd.docker.distribution.manifest.list.v2+json'
                  accept_manifest='application/vnd.oci.image.manifest.v1+json, application/vnd.docker.distribution.manifest.v2+json'

                  for tag in ${KEEP_TAGS}; do
                    if json=$(curl -fsSL -H "Authorization: Bearer ${token}" \
                                   -H "Accept: ${accept_index}" \
                                   "https://ghcr.io/v2/${repo}/manifests/${tag}" 2>/dev/null); then
                      echo "$json" | jq -r '.manifests[]?.digest' | sed '/^$/d' >> "$prot" || true
                    fi
                    head=$(curl -fsSLI -H "Authorization: Bearer ${token}" \
                                    -H "Accept: ${accept_index}, ${accept_manifest}" \
                                    "https://ghcr.io/v2/${repo}/manifests/${tag}" | tr -d '\r')
                    digest=$(printf '%s\n' "$head" | awk -F': ' '/^Docker-Content-Digest:/ {print $2}' | tail -n1)
                    [ -n "$digest" ] && echo "$digest" >> "$prot"
                  done

                  sort -u "$prot" -o "$prot"
                  protected_json="$(jq -Rsc 'split("\n")|map(select(length>0))' "$prot")"
                  {
                    echo "protected<<EOF"
                    echo "$protected_json"
                    echo "EOF"
                  } >> "$GITHUB_OUTPUT"

            - name: Plan
              id: plan
              env:
                  PROTECTED: ${{ steps.protect.outputs.protected }}
              shell: bash
              run: |
                  set -Eeuo pipefail
                  owner="${OWNER,,}"
                  image="${REPO#*/}"; image="${image,,}"
                  type="$(gh api "/users/${owner}" -q .type)"
                  [ "$type" = "Organization" ] && base="/orgs/${owner}" || base="/users/${owner}"
                  cutoff=$(date -u -d "${RETENTION_DAYS} days ago" +%s)

                  gh api --paginate -H "Accept: application/vnd.github+json" \
                    "${base}/packages/container/${image}/versions?per_page=100" \
                  | jq -r --arg re "${TEMP_TAG_REGEX}" \
                         --argjson prot "${PROTECTED:-[]}" \
                         --argjson cutoff "$cutoff" '
                      .[] | {
                        id,
                        digest: .name,
                        updated_at,
                        tags: (.metadata.container.tags // [])
                      }
                      | select([ .tags[]? | test($re) ] | any)
                      | select( ( .updated_at | fromdateiso8601 ) < $cutoff )
                      | select( ($prot | index(.digest)) | not )
                      | .id
                    ' > ids.txt

                  echo "ids<<EOF" >> "$GITHUB_OUTPUT"
                  cat ids.txt >> "$GITHUB_OUTPUT"
                  echo "EOF" >> "$GITHUB_OUTPUT"

            - name: Delete
              if: steps.plan.outputs.ids != ''
              env:
                  IDS: ${{ steps.plan.outputs.ids }}
              shell: bash
              run: |
                  set -Eeuo pipefail
                  owner="${OWNER,,}"
                  image="${REPO#*/}"; image="${image,,}"
                  type="$(gh api "/users/${owner}" -q .type)"
                  [ "$type" = "Organization" ] && base="/orgs/${owner}" || base="/users/${owner}"

                  deleted=0
                  while read -r id; do
                    [ -n "$id" ] || continue
                    if [ "$DRY_RUN" = "true" ]; then
                      echo "DRY_RUN: would delete $id"
                      continue
                    fi
                    gh api -X DELETE -H "Accept: application/vnd.github+json" \
                      "${base}/packages/container/${image}/versions/${id}"
                    deleted=$((deleted+1))
                  done <<< "$IDS"
                  echo "Deleted=$deleted"
