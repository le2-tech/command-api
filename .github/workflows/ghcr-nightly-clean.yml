name: GHCR nightly cleanup (single script + diagnostics)

on:
  schedule:
    - cron: "30 18 * * *"  # 每天 JST 03:30（UTC 18:30）
  workflow_dispatch:
    inputs:
      retention_days:
        description: "临时标签至少保留天数（建议 3）"
        type: number
        default: 3
      debug:
        description: "开启脚本 set -x（可能打印命令参数，注意脱敏）"
        type: boolean
        default: false

permissions:
  packages: write
  contents: read

env:
  REPO: ${{ github.repository }}                       # owner/repo
  OWNER: ${{ github.repository_owner }}
  KEEP_TAGS: ${{ format('latest {0}', github.event.repository.default_branch || 'main') }}
  RETENTION_DAYS: ${{ (github.event_name == 'workflow_dispatch' && inputs.retention_days) || 3 }}
  # 更宽松：短/长 SHA 都匹配；若只用 40 位，请改为 ^[0-9a-f]{40}-(amd64|arm64)$
  TEMP_TAG_REGEX: '^[0-9a-f]{7,40}-(amd64|arm64)$'

jobs:
  cleanup:
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      DEBUG: ${{ (github.event_name == 'workflow_dispatch' && (inputs.debug && '1' || '0')) || '0' }}
    steps:
      - uses: actions/checkout@v4

      - name: Run cleanup script
        run: |
          chmod +x .github/scripts/ghcr-clean.sh
          .github/scripts/ghcr-clean.sh
